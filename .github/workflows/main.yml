name: "üé£ HappyMancing ‚Äî ULTRA FAST DEPLOY"

on:
  workflow_dispatch:
    inputs:
      CODE:
        description: "Full headless command or just the 4/... token from https://remotedesktop.google.com/headless (Windows)."
        required: true
      PIN:
        description: "CRD PIN (6+ digits). Default 123456"
        required: false
        default: "123456"
      RETRIES:
        description: "Retries for start-host (default 2)"
        required: false
        default: "2"

permissions:
  contents: read

concurrency:
  group: crd-register-${{ github.ref }}-${{ github.run_id }}
  cancel-in-progress: false

jobs:
  crd-register:
    name: "üé£ HappyMancing ULTRA FAST"
    runs-on: windows-2022
    timeout-minutes: 45  # Prevent hanging

    env:
      RAW_CODE:      ${{ github.event.inputs.CODE }}
      PIN_INPUT:     ${{ github.event.inputs.PIN }}
      RETRIES_INPUT: ${{ github.event.inputs.RETRIES }}
      HappyMancing_Access_Token: ${{ secrets.HappyMancing_Access_Token }}

    defaults:
      run:
        shell: pwsh

    steps:
      - name: "‚ö° Pre-cache Downloads"
        run: |
          $ErrorActionPreference = 'Continue'
          # Parallel download semua file sekaligus
          $downloads = @(
            @{Url="https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi"; Path="$env:USERPROFILE\Downloads\crdhost.msi"},
            @{Url="https://raw.githubusercontent.com/kamavingabre-sketch/HM/refs/heads/main/MUMU.exe"; Path="$env:USERPROFILE\Downloads\MUMU.exe"},
            @{Url="https://raw.githubusercontent.com/kamavingabre-sketch/HM/refs/heads/main/setup.ps1"; Path="setup.ps1"},
            @{Url="https://raw.githubusercontent.com/kamavingabre-sketch/HM/refs/heads/main/GCRD-setup.ps1"; Path="GCRD-setup.ps1"}
          )
          
          $jobs = @()
          foreach ($dl in $downloads) {
            $jobs += Start-Job -ScriptBlock {
              param($url, $path)
              Invoke-WebRequest -Uri $url -OutFile $path -UseBasicParsing -TimeoutSec 30
            } -ArgumentList $dl.Url, $dl.Path
          }
          
          # Tunggu semua download selesai
          $jobs | Wait-Job -Timeout 60 | Out-Null
          Write-Host "‚úÖ All files pre-cached"

      - name: "üé£ ULTRA FAST Deployment"
        run: |
          $ErrorActionPreference = 'Stop'
          # Execute setup dengan timeout
          $process = Start-Process pwsh -ArgumentList "-ExecutionPolicy Bypass -File `"setup.ps1`" -GateSecret `"$env:HappyMancing_Access_Token`"" -PassThru -NoNewWindow
          
          # Timeout protection
          if (-not $process.WaitForExit(2400000)) { # 40 minutes timeout
            Write-Error "‚ùå Deployment timeout"
            exit 1
          }
          
          if ($process.ExitCode -ne 0) {
            Write-Error "‚ùå Deployment failed with exit code: $($process.ExitCode)"
            exit 1
          }
          
          Write-Host "‚úÖ Deployment completed in record time!"
